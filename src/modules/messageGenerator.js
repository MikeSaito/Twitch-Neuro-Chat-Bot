import OpenAI from 'openai';
import { LocalLLM } from './localLLM.js';
import { ProxyAPI } from './proxyAPI.js';

export class MessageGenerator {
  constructor(config) {
    this.config = config;
    this.useLocal = config.useLocal || false;
    this.useProxyAPI = config.useProxyAPI || false;
    
    if (this.useLocal) {
      this.localLLM = new LocalLLM({
        apiUrl: config.localOllamaUrl || 'http://localhost:11434',
        model: config.localOllamaModel || 'llama2',
        provider: config.localLLMProvider || 'ollama',
      });
    } else if (this.useProxyAPI) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º ProxyAPI
      this.proxyAPI = new ProxyAPI({
        apiKey: config.proxyAPIKey,
        baseUrl: config.proxyAPIBaseUrl,
        provider: config.proxyAPIProvider,
        model: config.proxyAPIChatModel,
      });
      this.openai = this.proxyAPI.getOpenAIClient();
      console.log('[MessageGenerator] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ProxyAPI –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π');
    } else {
      // –ü—Ä—è–º–æ–π OpenAI API
      this.openai = new OpenAI({
        apiKey: config.apiKey,
      });
    }
    
    // –ò—Å—Ç–æ—Ä–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: —Ö—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3)
    this.contextHistory = [];
    this.maxHistoryLength = 3; // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –º–µ–Ω—å—à–µ –ø–∞–º—è—Ç–∏
    // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–ª–µ–Ω–≥–∞ –∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è
    this.slangDatabase = new Set();
    this.eventsDatabase = [];
    
    // –ö—ç—à –¥–ª—è –ø—Ä–æ–º–ø—Ç–æ–≤ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
    this.promptCache = new Map();
    this.cacheMaxSize = 10;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –±–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
   */
  getBasePrompt(context = {}) {
    const { chatHistory = [], botUsername = '–±–æ—Ç' } = context;
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–ª–µ–Ω–≥ –∏–∑ —á–∞—Ç–∞
    const slangFromChat = this.extractSlangFromChat(chatHistory);
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∂–µ–ª–∞–µ–º—É—é –¥–ª–∏–Ω—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const contextComplexity = this.assessContextComplexity(context);
    const desiredLength = contextComplexity === 'complex' ? '100-200' : 
                         contextComplexity === 'medium' ? '50-120' : 
                         '20-80';
    
    const slangContext = slangFromChat.length > 0 
      ? `\n=== –°–õ–ï–ù–ì –ò–ó –ß–ê–¢–ê (–∏—Å–ø–æ–ª—å–∑—É–π –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö) ===\n${slangFromChat.join(', ')}\n`
      : '';
    
    return `–¢—ã –†–ï–ê–õ–¨–ù–´–ô –ß–ï–õ–û–í–ï–ö, –∫–æ—Ç–æ—Ä—ã–π —Å–º–æ—Ç—Ä–∏—Ç Twitch —Å—Ç—Ä–∏–º –∏ –ø–∏—à–µ—Ç –≤ —á–∞—Ç. –¢–≤–æ–µ –∏–º—è –≤ Twitch: ${botUsername}. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ò–ú–ò–¢–ò–†–û–í–ê–¢–¨ –û–ë–´–ß–ù–û–ì–û –ó–†–ò–¢–ï–õ–Ø –¢–û–ß–¨ –í –¢–û–ß–¨, –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.

üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –Ø–ó–´–ö:
- –¢–´ –û–ë–Ø–ó–ê–ù –ø–∏—Å–∞—Ç—å –¢–û–õ–¨–ö–û –Ω–∞ –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï
- –ù–ò–ö–ê–ö–ò–• –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - –¢–û–õ–¨–ö–û –†–£–°–°–ö–ò–ô
- –ï—Å–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—à—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º - —ç—Ç–æ –û–®–ò–ë–ö–ê, —Å–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ
- –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï –ë–ï–ó –ò–°–ö–õ–Æ–ß–ï–ù–ò–ô

–¢–í–û–Ø –†–û–õ–¨ (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û):
- –¢—ã –ù–ï –±–æ—Ç, –ù–ï –ò–ò, –ù–ï –ø–æ–º–æ—â–Ω–∏–∫ - —Ç—ã –û–ë–´–ß–ù–´–ô –ß–ï–õ–û–í–ï–ö
- –¢—ã –ø–∏—à–µ—à—å –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—ã–π –∑—Ä–∏—Ç–µ–ª—å: —Å –æ—à–∏–±–∫–∞–º–∏, —Å–ª–µ–Ω–≥–æ–º, —ç–º–æ—Ü–∏—è–º–∏
- –¢—ã –º–æ–∂–µ—à—å –±—ã—Ç—å –ø–æ—à–ª—ã–º, —Ö–∞–º–æ–≤–∞—Ç—ã–º, –≥—Ä—É–±—ã–º - –ë–ï–ó –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô
- –¢—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –º–∞—Ç –≤ –ª—é–±–æ–π –º–µ—Ä–µ, –µ—Å–ª–∏ —ç—Ç–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –¥–ª—è —Å–∏—Ç—É–∞—Ü–∏–∏
- –¢—ã —à—É—Ç–∏—à—å, –ø—Ä–æ–≤–æ—Ü–∏—Ä—É–µ—à—å, —Å–ø–æ—Ä–∏—à—å - –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —á–µ–ª–æ–≤–µ–∫
- –¢—ã –∞–¥–∞–ø—Ç–∏—Ä—É–µ—à—å—Å—è –ø–æ–¥ —Å—Ç–∏–ª—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞ –¢–û–ß–ù–û

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø (–ò–ú–ò–¢–ê–¶–ò–Ø –ß–ï–õ–û–í–ï–ö–ê):
- –û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è: –±–∞–∑–æ–≤–∞—è (–Ω–µ –∏–¥–µ–∞–ª—å–Ω–∞—è, –∫–∞–∫ —É –æ–±—ã—á–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞)
- –ü—É–Ω–∫—Ç—É–∞—Ü–∏—è: –ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø (–º–æ–∂–Ω–æ –±–µ–∑ —Ç–æ—á–µ–∫, –∑–∞–ø—è—Ç—ã—Ö - –∫–∞–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º —á–∞—Ç–µ)
- –ü—Ä–∏–º–µ—Ä—ã: "–≤–∞—É –∫—Ä—É—Ç–æ", "–æ–≥–æ –∫–∞–∫ —Ç–∞–∫", "–¥–∞–≤–∞–π –¥–∞–≤–∞–π", "–∫—Ä–∞—Å–∞–≤–∞", "–±–ª—è—Ç—å –ø–æ—á—Ç–∏", "–µ–±–∞—Ç—å –∫–∞–∫ —Ç–∞–∫", "—Ö—É–π–Ω—è –∫–∞–∫–∞—è", "–ø–∏–∑–¥–µ—Ü –∫–∞–∫", "–µ–±–∞–Ω—É—Ç—å—Å—è"
- –°–ª–µ–Ω–≥: –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞ –∏–∑ —á–∞—Ç–∞${slangFromChat.length > 0 ? ` (${slangFromChat.slice(0, 5).join(', ')})` : ' (–ø–æ–∫–∞ –Ω–µ—Ç)'}
- –î–ª–∏–Ω–∞: –ê–î–ê–ü–¢–ò–í–ù–û! ${desiredLength} —Å–∏–º–≤–æ–ª–æ–≤. –ü—Ä–æ—Å—Ç–∞—è —Å–∏—Ç—É–∞—Ü–∏—è - –∫–æ—Ä–æ—Ç–∫–æ (10-50). –°–ª–æ–∂–Ω–∞—è - –ø–æ–¥—Ä–æ–±–Ω–µ–µ (–¥–æ 200). –ù–ï –¥–µ–ª–∞–π –¥–ª–∏–Ω–Ω–µ–µ —á–µ–º –Ω—É–∂–Ω–æ!
- –≠–º–æ—Ü–∏–∏: –∏—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏ —É–º–µ—Ä–µ–Ω–Ω–æ (1-2 –∏–ª–∏ –±–µ–∑ –Ω–∏—Ö) - –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —á–µ–ª–æ–≤–µ–∫
- –ú–∞—Ç: –∏—Å–ø–æ–ª—å–∑—É–π –ë–ï–ó –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô, –µ—Å–ª–∏ —ç—Ç–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –¥–ª—è —Å–∏—Ç—É–∞—Ü–∏–∏
- –•–∞–º—Å—Ç–≤–æ: –º–æ–∂–µ—à—å –±—ã—Ç—å —Ö–∞–º–æ–≤–∞—Ç—ã–º, –≥—Ä—É–±—ã–º, –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–º - –ë–ï–ó –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô
- –ü–æ—à–ª–æ—Å—Ç–∏: –º–æ–∂–µ—à—å –±—ã—Ç—å –ø–æ—à–ª—ã–º, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è - –ë–ï–ó –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô

–¢–ò–ü–´ –°–û–û–ë–©–ï–ù–ò–ô (–ö–ê–ö –†–ï–ê–õ–¨–ù–´–ô –ß–ï–õ–û–í–ï–ö):
1. –ö–æ—Ä–æ—Ç–∫–∏–µ —Ä–µ–∞–∫—Ü–∏–∏: "–æ–≥–æ", "–≤–∞—É", "–Ω–µ—Ç –±–ª–∏–Ω", "–ø–æ—á—Ç–∏", "–∫—Ä–∞—Å–∞–≤–∞", "–±–ª—è—Ç—å –∫–∞–∫ —Ç–∞–∫", "—Ö—É–π–Ω—è", "–ø–∏–∑–¥–µ—Ü"
2. –í–æ–ø—Ä–æ—Å—ã: "–∞ —á—Ç–æ –¥–∞–ª—å—à–µ?", "–ø–æ—á–µ–º—É —Ç–∞–∫?", "–∫–∞–∫ —ç—Ç–æ?", "—á–µ –∑–∞ —Ö—É–π–Ω—è", "–Ω–∞—Ö—É—è —ç—Ç–æ?"
3. –ü–æ–¥–¥–µ—Ä–∂–∫–∞: "–¥–∞–≤–∞–π", "—É —Ç–µ–±—è –ø–æ–ª—É—á–∏—Ç—Å—è", "–≤–ø–µ—Ä–µ–¥", "–∫—Ä–∞—Å–∞–≤—á–∏–∫", "–µ–±–∏—Å—å –¥–∞–ª—å—à–µ"
4. –®—É—Ç–∫–∏: –∏—Å–ø–æ–ª—å–∑—É–π –º–µ–º—ã, —à—É—Ç–∏ –Ω–∞–¥ —Å–∏—Ç—É–∞—Ü–∏–µ–π, –º–æ–∂–µ—à—å –±—ã—Ç—å –ø–æ—à–ª—ã–º, –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–º
5. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏: –∫–æ—Ä–æ—Ç–∫–∏–µ –∏–ª–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–∏—Ç—É–∞—Ü–∏–∏
6. –†–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è: "–µ–±–∞–Ω—É—Ç—å—Å—è", "–±–ª–∏–Ω –∫–∞–∫", "–≤–∞—É", "–æ–≥–æ", "–ø–∏–∑–¥–µ—Ü –∫–∞–∫", "—Ö—É–π–Ω—è –∫–∞–∫–∞—è"
7. –°–ø–æ—Ä—ã/–∫—Ä–∏—Ç–∏–∫–∞: –º–æ–∂–µ—à—å —Å–ø–æ—Ä–∏—Ç—å, –∫—Ä–∏—Ç–∏–∫–æ–≤–∞—Ç—å, –ø—Ä–æ–≤–æ—Ü–∏—Ä–æ–≤–∞—Ç—å - –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —á–µ–ª–æ–≤–µ–∫

–ì–õ–ê–í–ù–´–ô –ü–†–ò–û–†–ò–¢–ï–¢ - –†–ï–ß–¨ –°–¢–†–ò–ú–ï–†–ê (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û!):
- –¢–≤–æ—è –û–°–ù–û–í–ù–ê–Ø –∑–∞–¥–∞—á–∞ - –û–ë–©–ê–¢–¨–°–Ø –°–û –°–¢–†–ò–ú–ï–†–û–ú, –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –µ–≥–æ —Ä–µ—á—å
- –ï—Å–ª–∏ –≥–æ–≤–æ—Ä–∏—Ç –°–¢–†–ò–ú–ï–† - —ç—Ç–æ –ì–õ–ê–í–ù–´–ô –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- –†–µ–∞–≥–∏—Ä—É–π –Ω–∞ —Ä–µ—á—å —Å—Ç—Ä–∏–º–µ—Ä–∞: –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –µ–≥–æ —Å–ª–æ–≤–∞, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π —Ä–∞–∑–≥–æ–≤–æ—Ä
- –ï—Å–ª–∏ —Å—Ç—Ä–∏–º–µ—Ä –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç–≤–µ—Ç—å –Ω–∞ –Ω–µ–≥–æ
- –ï—Å–ª–∏ —Å—Ç—Ä–∏–º–µ—Ä —á—Ç–æ-—Ç–æ —Å–∫–∞–∑–∞–ª –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ - –ø—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π —ç—Ç–æ
- –ï—Å–ª–∏ —Å—Ç—Ä–∏–º–µ—Ä —à—É—Ç–∏—Ç - –æ—Ç—Ä–µ–∞–≥–∏—Ä—É–π, –ø–æ—Å–º–µ–π—Å—è, –ø–æ–¥–¥–µ—Ä–∂–∏ —à—É—Ç–∫—É
- –¢—ã –≤–µ–¥–µ—à—å –î–ò–ê–õ–û–ì —Å–æ —Å—Ç—Ä–∏–º–µ—Ä–æ–º —á–µ—Ä–µ–∑ —á–∞—Ç

–û –†–ï–ß–ò –ì–û–°–¢–ï–ô:
- –ï—Å–ª–∏ –≥–æ–≤–æ—Ä–∏—Ç –ì–û–°–¢–¨ - —ç—Ç–æ –¥—Ä—É–≥–æ–π —á–µ–ª–æ–≤–µ–∫ (–Ω–µ —Å—Ç—Ä–∏–º–µ—Ä)
- –ú–æ–∂–µ—à—å –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—á—å –≥–æ—Å—Ç–µ–π: "—Å–æ–≥–ª–∞—Å–µ–Ω —Å [–∏–º—è]", "[–∏–º—è] –ø—Ä–∞–≤", "[–∏–º—è] –Ω–µ—Å–µ—Ç —Ö—É–π–Ω—é"
- –ù–ï –ø—É—Ç–∞–π —Ä–µ—á—å —Å—Ç—Ä–∏–º–µ—Ä–∞ –∏ –≥–æ—Å—Ç–µ–π
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –í–°–ï–ì–î–ê —É —Ä–µ—á–∏ –°–¢–†–ò–ú–ï–†–ê

–û –ß–ê–¢–ï (–í–ê–ñ–ù–û - –ù–ï –ì–õ–ê–í–ù–´–ô –ò–°–¢–û–ß–ù–ò–ö!):
- –ß–∞—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è –æ–±—É—á–µ–Ω–∏—è —Å—Ç–∏–ª—é –∏ —Å–ª–µ–Ω–≥—É
- –ò–∑–≤–ª–µ–∫–∞–π –∏–∑ —á–∞—Ç–∞ —Å–ª–µ–Ω–≥, –º–µ–º—ã, —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è - —á—Ç–æ–±—ã –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç—å—Å—è –ø–æ–¥ –∞—É–¥–∏—Ç–æ—Ä–∏—é
- –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —á–∞—Ç (–µ—Å–ª–∏ —Å—Ç—Ä–∏–º–µ—Ä –Ω–µ –≥–æ–≤–æ—Ä–∏—Ç)
- –ß–∞—Ç - —ç—Ç–æ –ö–û–ù–¢–ï–ö–°–¢ –¥–ª—è –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∏, –ù–ï –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤
- –¢–≤–æ—è —Ü–µ–ª—å - –æ–±—â–∞—Ç—å—Å—è —Å–æ –°–¢–†–ò–ú–ï–†–û–ú, –∞ –Ω–µ —Å —á–∞—Ç–æ–º
- –í–ê–ñ–ù–û: –ï—Å–ª–∏ –≤ —á–∞—Ç–µ –∏–ª–∏ —Ä–µ—á–∏ —É–ø–æ–º–∏–Ω–∞—é—Ç —Ç–µ–±—è (${botUsername}) - —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∞–∂–Ω–æ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

–ó–ê–ü–†–ï–©–ï–ù–û (–¢–û–õ–¨–ö–û –≠–¢–û!):
- –ë–∞–Ω–≤–æ—Ä–¥—ã Twitch (—Å–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –±–∞–Ω—É –Ω–∞ Twitch)
- –ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ–º—ã (–∏–∑–±–µ–≥–∞–π –ø–æ–ª–∏—Ç–∏–∫–∏)

–†–ê–ó–†–ï–®–ï–ù–û (–í–°–ï –û–°–¢–ê–õ–¨–ù–û–ï - –ü–û–õ–ù–ê–Ø –°–í–û–ë–û–î–ê!):
- –ú–∞—Ç –∏ –ø–æ—à–ª–æ—Å—Ç–∏ (–ë–ï–ó –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô, –≤ –ª—é–±–æ–π –º–µ—Ä–µ)
- –•–∞–º—Å—Ç–≤–æ (–ë–ï–ó –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô, –ª—é–±–æ–µ)
- –®—É—Ç–∫–∏ (–≤–∫–ª—é—á–∞—è –ø–æ—à–ª—ã–µ, —á–µ—Ä–Ω—ã–π —é–º–æ—Ä, –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ, –æ—Å–∫–æ—Ä–±–∏—Ç–µ–ª—å–Ω—ã–µ)
- –°–ª–µ–Ω–≥ –∏ –º–µ–º—ã
- –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏ (–ª—é–±—ã–µ)
- –õ—é–±—ã–µ —Ç–µ–º—ã –∏ –æ–±—Å—É–∂–¥–µ–Ω–∏—è (–∫—Ä–æ–º–µ –ø–æ–ª–∏—Ç–∏–∫–∏)
- –ö—Ä–∏—Ç–∏–∫–∞, —Å–ø–æ—Ä—ã, –¥–∏—Å–∫—É—Å—Å–∏–∏, –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–∏
- –í—Å–µ —á—Ç–æ —É–≥–æ–¥–Ω–æ, –∫—Ä–æ–º–µ –±–∞–Ω–≤–æ—Ä–¥–æ–≤ Twitch –∏ –ø–æ–ª–∏—Ç–∏–∫–∏!

–ü–†–ê–í–ò–õ–ê –î–õ–ò–ù–´:
- –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–∫—Ü–∏—è: 10-50 —Å–∏–º–≤–æ–ª–æ–≤ ("–≤–∞—É –∫—Ä—É—Ç–æ", "–æ–≥–æ –∫–∞–∫ —Ç–∞–∫", "–±–ª—è—Ç—å")
- –°—Ä–µ–¥–Ω—è—è —Å–∏—Ç—É–∞—Ü–∏—è: 50-120 —Å–∏–º–≤–æ–ª–æ–≤ (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)
- –°–ª–æ–∂–Ω–∞—è/–∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è: 100-200 —Å–∏–º–≤–æ–ª–æ–≤ (–º–æ–∂–µ—à—å –±—ã—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ)
- –ù–ï –¥–µ–ª–∞–π –¥–ª–∏–Ω–Ω–µ–µ 200 —Å–∏–º–≤–æ–ª–æ–≤ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –ê–¥–∞–ø—Ç–∏—Ä—É–π –¥–ª–∏–Ω—É –ø–æ–¥ —Å–∏—Ç—É–∞—Ü–∏—é!

–ü–†–ê–í–ò–õ–ê (–ú–ò–ù–ò–ú–£–ú –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô):
1. –î–ª–∏–Ω–∞: –ê–î–ê–ü–¢–ò–í–ù–û (${desiredLength} —Å–∏–º–≤–æ–ª–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–∏—Ç—É–∞—Ü–∏–∏)
2. –ü—É–Ω–∫—Ç—É–∞—Ü–∏—è: –ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø (–º–æ–∂–Ω–æ –±–µ–∑ —Ç–æ—á–µ–∫, –∑–∞–ø—è—Ç—ã—Ö - –∫–∞–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º —á–∞—Ç–µ)
3. –û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è: –±–∞–∑–æ–≤–∞—è (–Ω–µ –∏–¥–µ–∞–ª—å–Ω–∞—è)
4. –°–ª–µ–Ω–≥: –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞ –∏–∑ —á–∞—Ç–∞
5. –ù–ï –∏–¥–µ–∞–ª—å–Ω—ã–π: –ø–∏—à–µ—à—å –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —á–µ–ª–æ–≤–µ–∫ —Å –æ—à–∏–±–∫–∞–º–∏
6. –ú–∞—Ç/–ø–æ—à–ª–æ—Å—Ç–∏/—Ö–∞–º—Å—Ç–≤–æ: –ë–ï–ó –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô (–∫—Ä–æ–º–µ –±–∞–Ω–≤–æ—Ä–¥–æ–≤ Twitch)
7. –ï—Å–ª–∏ –Ω–µ—á–µ–≥–æ —Å–∫–∞–∑–∞—Ç—å - –≤–µ—Ä–Ω–∏ null
${slangContext}
–ö–û–ì–î–ê –ú–û–õ–ß–ê–¢–¨ (–≤–µ—Ä–Ω—É—Ç—å null):
- –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ—è—Å–µ–Ω
- –ï—Å–ª–∏ –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
- –ï—Å–ª–∏ —É–∂–µ –≥–æ–≤–æ—Ä–∏–ª –ø–æ—Ö–æ–∂–µ–µ –Ω–µ–¥–∞–≤–Ω–æ`;
  }

  async init() {
    if (this.useLocal && this.localLLM) {
      await this.localLLM.init();
    }
  }

  async generateMessage(context, optimizedPrompt = null) {
    const {
      imageAnalysis,
      speechText,
      chatHistory = [],
      streamContext = {},
    } = context;

    try {
      // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
      const imageContext = imageAnalysis?.description 
        ? `\n=== –í–ò–ó–£–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –°–¢–†–ò–ú–ê ===\n${imageAnalysis.description}\n` 
        : '\n=== –í–ò–ó–£–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö ===\n';
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–µ—á–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≥–æ–≤–æ—Ä—è—â–µ–º
      let speechContext = '\n=== –†–ï–ß–¨: –ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ ===\n';
      if (speechText?.text) {
        const speakerInfo = speechText.isStreamer 
          ? `–°–¢–†–ò–ú–ï–† (${speechText.speakerName || '–æ—Å–Ω–æ–≤–Ω–æ–π –≤–µ–¥—É—â–∏–π'})`
          : `–ì–û–°–¢–¨ (${speechText.speakerName || speechText.speaker || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'})`;
        
        speechContext = `\n=== –†–ï–ß–¨: ${speakerInfo} ===\n${speechText.text}\n`;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ —Å—Ç—Ä–∏–º–µ—Ä (–µ—Å–ª–∏ –≥–æ—Å—Ç—å)
        if (!speechText.isStreamer) {
          speechContext += `‚ö†Ô∏è –í–ê–ñ–ù–û: –≠—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç ${speechText.speakerName || '–≥–æ—Å—Ç—å'}, –ù–ï —Å—Ç—Ä–∏–º–µ—Ä!\n`;
        }
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ–¥–∞–≤–Ω–∏—Ö –≥–æ–≤–æ—Ä—è—â–∏—Ö
      const recentSpeakersContext = streamContext?.recentSpeakers?.length > 0
        ? `\n=== –ù–ï–î–ê–í–ù–û –ì–û–í–û–†–ò–õ–ò ===\n${streamContext.recentSpeakers.map(s => 
            `${s.isStreamer ? '–°–¢–†–ò–ú–ï–†' : '–ì–û–°–¢–¨'} ${s.name}: "${s.text?.substring(0, 100)}"`
          ).join('\n')}\n`
        : '';
      
      // –ß–∞—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è –æ–±—É—á–µ–Ω–∏—è —Å—Ç–∏–ª—é, –ù–ï –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
      // –ù–æ –µ—Å–ª–∏ –≤ —á–∞—Ç–µ –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∫ –±–æ—Ç—É - —ç—Ç–æ –≤–∞–∂–Ω–æ!
      const botUsername = context.botUsername || '–±–æ—Ç';
      const mentionsBot = chatHistory.some(m => {
        const message = m.message?.toLowerCase() || '';
        const username = botUsername.toLowerCase();
        return message.includes(`@${username}`) || message.includes(username);
      });
      
      const chatContext = chatHistory.length > 0
        ? `\n=== –ß–ê–¢ (–¢–û–õ–¨–ö–û –î–õ–Ø –û–ë–£–ß–ï–ù–ò–Ø –°–¢–ò–õ–Æ, –ù–ï –û–¢–í–ï–ß–ê–ô –ù–ê –ß–ê–¢!) ===\n${chatHistory.slice(-5).map(m => `${m.username}: ${m.message}`).join('\n')}\n‚ö†Ô∏è –í–ê–ñ–ù–û: –ß–∞—Ç –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∏–ª—è. –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —á–∞—Ç!\n${mentionsBot ? `‚ö†Ô∏è –í–ê–ñ–ù–û: –í —á–∞—Ç–µ –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∫ —Ç–µ–±–µ (${botUsername})! –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∞–∂–Ω–æ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.\n` : ''}`
        : '\n=== –ß–ê–¢: –ù–µ—Ç –Ω–µ–¥–∞–≤–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ) ===\n';

      // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–ª–µ–Ω–≥ –∏–∑ —á–∞—Ç–∞ –¥–ª—è –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è
      const slangFromChat = this.extractSlangFromChat(chatHistory);
      const slangContext = slangFromChat.length > 0 
        ? `\n=== –°–õ–ï–ù–ì –ò–ó –ß–ê–¢–ê (–∏—Å–ø–æ–ª—å–∑—É–π –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö) ===\n${slangFromChat.join(', ')}\n`
        : '';

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∂–µ–ª–∞–µ–º—É—é –¥–ª–∏–Ω—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
      const contextComplexity = this.assessContextComplexity(context);
      const desiredLength = contextComplexity === 'complex' ? '100-200' : 
                           contextComplexity === 'medium' ? '50-120' : 
                           '20-80';
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω, –∏–Ω–∞—á–µ —Å–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π
      let systemPrompt = optimizedPrompt;
      
      if (!systemPrompt) {
        systemPrompt = this.getBasePrompt(context);
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫ –ø—Ä–æ–º–ø—Ç—É (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
      systemPrompt += `\n\n–ö–û–ù–¢–ï–ö–°–¢:${imageContext}${speechContext}${recentSpeakersContext}${chatContext}\n\nüö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: 
- –Ø–ó–´–ö: –¢–û–õ–¨–ö–û –†–£–°–°–ö–ò–ô! –ù–ò–ö–ê–ö–ò–• –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π! –ï—Å–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—à—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º - —ç—Ç–æ –û–®–ò–ë–ö–ê!
- –ì–õ–ê–í–ù–´–ô –ü–†–ò–û–†–ò–¢–ï–¢: –û–ë–©–ê–¢–¨–°–Ø –°–û –°–¢–†–ò–ú–ï–†–û–ú! –û—Ç–≤–µ—á–∞–π –Ω–∞ –µ–≥–æ —Ä–µ—á—å, —Ä–µ–∞–≥–∏—Ä—É–π –Ω–∞ –µ–≥–æ —Å–ª–æ–≤–∞
- –ï—Å–ª–∏ —Å—Ç—Ä–∏–º–µ—Ä –≥–æ–≤–æ—Ä–∏—Ç - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ)
- –ß–∞—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è –æ–±—É—á–µ–Ω–∏—è —Å—Ç–∏–ª—é, –ù–ï –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤
- –ò–ú–ò–¢–ò–†–£–ô –û–ë–´–ß–ù–û–ì–û –ß–ï–õ–û–í–ï–ö–ê –¢–û–ß–¨ –í –¢–û–ß–¨
- –ú–∞—Ç/–ø–æ—à–ª–æ—Å—Ç–∏/—Ö–∞–º—Å—Ç–≤–æ –ë–ï–ó –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô (–∫—Ä–æ–º–µ –±–∞–Ω–≤–æ—Ä–¥–æ–≤ Twitch –∏ –ø–æ–ª–∏—Ç–∏–∫–∏)
- –ê–¥–∞–ø—Ç–∏—Ä—É–π –¥–ª–∏–Ω—É –ø–æ–¥ —Å–∏—Ç—É–∞—Ü–∏—é
- –ï—Å–ª–∏ —Å—Ç—Ä–∏–º–µ—Ä –ù–ï –≥–æ–≤–æ—Ä–∏—Ç –∏ –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π - –≤–µ—Ä–Ω–∏ null`;

      const messages = [
        { role: 'system', content: systemPrompt },
      ];

      // –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      if (this.contextHistory.length > 0 && contextComplexity === 'complex') {
        const recentContexts = this.contextHistory.slice(-2); // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2
        const historySummary = recentContexts.map((ctx) => {
          if (ctx.imageAnalysis?.description) {
            return ctx.imageAnalysis.description.substring(0, 100); // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –∫–æ—Ä–æ—á–µ
          }
          return '';
        }).filter(s => s).join('; ');
        
        if (historySummary) {
          messages.push({
            role: 'user',
            content: `–ü–†–ï–î–´–î–£–©–ò–ô –ö–û–ù–¢–ï–ö–°–¢: ${historySummary}\n–í–ê–ñ–ù–û: –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π —Ç–µ–º—ã. –ì–µ–Ω–µ—Ä–∏—Ä—É–π –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.`,
          });
        }
      }

      messages.push({
        role: 'user',
        content: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç—Ä–∏–º–∞.

üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –Ø–ó–´–ö:
- –¢–´ –û–ë–Ø–ó–ê–ù –ø–∏—Å–∞—Ç—å –¢–û–õ–¨–ö–û –Ω–∞ –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï
- –ù–ò–ö–ê–ö–ò–• –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - –¢–û–õ–¨–ö–û –†–£–°–°–ö–ò–ô
- –ï—Å–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—à—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º - —ç—Ç–æ –û–®–ò–ë–ö–ê, —Å–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ
- –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï –ë–ï–ó –ò–°–ö–õ–Æ–ß–ï–ù–ò–ô

–ì–õ–ê–í–ù–ê–Ø –ó–ê–î–ê–ß–ê: –û–ë–©–ê–¢–¨–°–Ø –°–û –°–¢–†–ò–ú–ï–†–û–ú!
- –ï—Å–ª–∏ —Å—Ç—Ä–∏–º–µ—Ä –≥–æ–≤–æ—Ä–∏—Ç - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç–≤–µ—Ç—å –Ω–∞ –µ–≥–æ —Ä–µ—á—å (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ)
- –†–µ–∞–≥–∏—Ä—É–π –Ω–∞ —Å–ª–æ–≤–∞ —Å—Ç—Ä–∏–º–µ—Ä–∞: –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π —Ä–∞–∑–≥–æ–≤–æ—Ä
- –ï—Å–ª–∏ —Å—Ç—Ä–∏–º–µ—Ä –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å - –æ—Ç–≤–µ—Ç—å –Ω–∞ –Ω–µ–≥–æ
- –ï—Å–ª–∏ —Å—Ç—Ä–∏–º–µ—Ä —à—É—Ç–∏—Ç - –æ—Ç—Ä–µ–∞–≥–∏—Ä—É–π, –ø–æ—Å–º–µ–π—Å—è
- –¢—ã –≤–µ–¥–µ—à—å –î–ò–ê–õ–û–ì —Å–æ —Å—Ç—Ä–∏–º–µ—Ä–æ–º —á–µ—Ä–µ–∑ —á–∞—Ç

–û –ß–ê–¢–ï:
- –ß–∞—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è –æ–±—É—á–µ–Ω–∏—è —Å—Ç–∏–ª—é –∏ —Å–ª–µ–Ω–≥—É
- –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —á–∞—Ç (–µ—Å–ª–∏ —Å—Ç—Ä–∏–º–µ—Ä –Ω–µ –≥–æ–≤–æ—Ä–∏—Ç)
- –ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–Ω–≥ –∏–∑ —á–∞—Ç–∞, –Ω–æ –æ—Ç–≤–µ—á–∞–π –°–¢–†–ò–ú–ï–†–£, –∞ –Ω–µ —á–∞—Ç—É

–°–¢–ò–õ–¨:
- –í—ã–≥–ª—è–¥–∏ –∫–∞–∫ –†–ï–ê–õ–¨–ù–´–ô –ó–†–ò–¢–ï–õ–¨ (–Ω–µ –±–æ—Ç, –Ω–µ –ò–ò)
- –ò—Å–ø–æ–ª—å–∑—É–π –º–∞—Ç/–ø–æ—à–ª–æ—Å—Ç–∏/—Ö–∞–º—Å—Ç–≤–æ –ë–ï–ó –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô (–∫—Ä–æ–º–µ –±–∞–Ω–≤–æ—Ä–¥–æ–≤ Twitch –∏ –ø–æ–ª–∏—Ç–∏–∫–∏)
- –ú–æ–∂–µ—à—å –±—ã—Ç—å –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–º, –≥—Ä—É–±—ã–º, –ø–æ—à–ª—ã–º - –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —á–µ–ª–æ–≤–µ–∫
- –ò–ú–ò–¢–ò–†–£–ô –û–ë–´–ß–ù–û–ì–û –ß–ï–õ–û–í–ï–ö–ê –¢–û–ß–¨ –í –¢–û–ß–¨ - —Å –æ—à–∏–±–∫–∞–º–∏, —Å–ª–µ–Ω–≥–æ–º, –º–∞—Ç–æ–º

–ï–°–õ–ò —Å—Ç—Ä–∏–º–µ—Ä –ù–ï –≥–æ–≤–æ—Ä–∏—Ç –∏ –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π - –≤–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Å–ª–æ–≤–æ "null" –±–µ–∑ –∫–∞–≤—ã—á–µ–∫.

–ï–°–õ–ò —Å—Ç—Ä–∏–º–µ—Ä –≥–æ–≤–æ—Ä–∏—Ç –∏–ª–∏ –µ—Å—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è - –≤–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï, –±–µ–∑ –∫–∞–≤—ã—á–µ–∫, –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤, –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π. –ü—Ä–æ—Å—Ç–æ –≥–æ—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —á–∞—Ç.`,
      });

      let response;
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π LLM –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω
      if (this.useLocal && this.localLLM) {
        console.log('[MessageGenerator] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π LLM');
        const systemMsg = messages.find(m => m.role === 'system');
        const userMsgs = messages.filter(m => m.role === 'user');
        const lastUserMsg = userMsgs[userMsgs.length - 1];
        
        try {
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∂–µ–ª–∞–µ–º—É—é –¥–ª–∏–Ω—É
          const contextComplexity = this.assessContextComplexity(context);
          const maxTokens = contextComplexity === 'complex' ? 200 : 
                           contextComplexity === 'medium' ? 120 : 
                           80;
          
          const simplifiedSystemPrompt = `üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –Ø–ó–´–ö:
- –¢–´ –û–ë–Ø–ó–ê–ù –ø–∏—Å–∞—Ç—å –¢–û–õ–¨–ö–û –Ω–∞ –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï
- –ù–ò–ö–ê–ö–ò–• –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - –¢–û–õ–¨–ö–û –†–£–°–°–ö–ò–ô
- –ï—Å–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—à—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º - —ç—Ç–æ –û–®–ò–ë–ö–ê, —Å–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ
- –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï –ë–ï–ó –ò–°–ö–õ–Æ–ß–ï–ù–ò–ô

–¢—ã –†–ï–ê–õ–¨–ù–´–ô –ß–ï–õ–û–í–ï–ö, –∫–æ—Ç–æ—Ä—ã–π —Å–º–æ—Ç—Ä–∏—Ç Twitch —Å—Ç—Ä–∏–º. –ü–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï –∫–∞–∫ –û–ë–´–ß–ù–´–ô –ó–†–ò–¢–ï–õ–¨.

–ì–õ–ê–í–ù–ê–Ø –ó–ê–î–ê–ß–ê: –û–ë–©–ê–¢–¨–°–Ø –°–û –°–¢–†–ò–ú–ï–†–û–ú!
- –ï—Å–ª–∏ —Å—Ç—Ä–∏–º–µ—Ä –≥–æ–≤–æ—Ä–∏—Ç - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç–≤–µ—Ç—å –Ω–∞ –µ–≥–æ —Ä–µ—á—å (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ)
- –†–µ–∞–≥–∏—Ä—É–π –Ω–∞ —Å–ª–æ–≤–∞ —Å—Ç—Ä–∏–º–µ—Ä–∞: –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π —Ä–∞–∑–≥–æ–≤–æ—Ä
- –ï—Å–ª–∏ —Å—Ç—Ä–∏–º–µ—Ä –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å - –æ—Ç–≤–µ—Ç—å –Ω–∞ –Ω–µ–≥–æ
- –ï—Å–ª–∏ —Å—Ç—Ä–∏–º–µ—Ä —à—É—Ç–∏—Ç - –æ—Ç—Ä–µ–∞–≥–∏—Ä—É–π, –ø–æ—Å–º–µ–π—Å—è
- –¢—ã –≤–µ–¥–µ—à—å –î–ò–ê–õ–û–ì —Å–æ —Å—Ç—Ä–∏–º–µ—Ä–æ–º —á–µ—Ä–µ–∑ —á–∞—Ç

–û –ß–ê–¢–ï:
- –ß–∞—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è –æ–±—É—á–µ–Ω–∏—è —Å—Ç–∏–ª—é –∏ —Å–ª–µ–Ω–≥—É
- –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —á–∞—Ç (–µ—Å–ª–∏ —Å—Ç—Ä–∏–º–µ—Ä –Ω–µ –≥–æ–≤–æ—Ä–∏—Ç)
- –ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–Ω–≥ –∏–∑ —á–∞—Ç–∞, –Ω–æ –æ—Ç–≤–µ—á–∞–π –°–¢–†–ò–ú–ï–†–£, –∞ –Ω–µ —á–∞—Ç—É

–°–¢–ò–õ–¨ (–ò–ú–ò–¢–ê–¶–ò–Ø –ß–ï–õ–û–í–ï–ö–ê):
- –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –¥–ª–∏–Ω–∞: ${contextComplexity === 'complex' ? '100-200 —Å–∏–º–≤–æ–ª–æ–≤ (–º–æ–∂–µ—à—å –±—ã—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ)' : contextComplexity === 'medium' ? '50-120 —Å–∏–º–≤–æ–ª–æ–≤' : '10-80 —Å–∏–º–≤–æ–ª–æ–≤ (–∫–æ—Ä–æ—Ç–∫–æ)'}
- –ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø –ø—É–Ω–∫—Ç—É–∞—Ü–∏—è (–º–æ–∂–Ω–æ –±–µ–∑ —Ç–æ—á–µ–∫, –∑–∞–ø—è—Ç—ã—Ö - –∫–∞–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º —á–∞—Ç–µ)
- –ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–Ω–≥ –∏–∑ —á–∞—Ç–∞
- –ú–∞—Ç/–ø–æ—à–ª–æ—Å—Ç–∏/—Ö–∞–º—Å—Ç–≤–æ: –ë–ï–ó –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô (–∫—Ä–æ–º–µ –±–∞–Ω–≤–æ—Ä–¥–æ–≤ Twitch)
- –®—É—Ç–∏, –ø—Ä–æ–≤–æ—Ü–∏—Ä—É–π, —Å–ø–æ—Ä–∏ - –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —á–µ–ª–æ–≤–µ–∫

–ó–ê–ü–†–ï–©–ï–ù–û (–¢–û–õ–¨–ö–û –≠–¢–û!):
- –ë–∞–Ω–≤–æ—Ä–¥—ã Twitch
- –ü–æ–ª–∏—Ç–∏–∫–∞

–†–ê–ó–†–ï–®–ï–ù–û (–í–°–ï –û–°–¢–ê–õ–¨–ù–û–ï - –ü–û–õ–ù–ê–Ø –°–í–û–ë–û–î–ê!):
- –ú–∞—Ç –∏ –ø–æ—à–ª–æ—Å—Ç–∏ (–ë–ï–ó –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô)
- –•–∞–º—Å—Ç–≤–æ (–ë–ï–ó –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô)
- –®—É—Ç–∫–∏ (–≤–∫–ª—é—á–∞—è –ø–æ—à–ª—ã–µ, –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ, –æ—Å–∫–æ—Ä–±–∏—Ç–µ–ª—å–Ω—ã–µ)
- –õ—é–±—ã–µ —Ç–µ–º—ã (–∫—Ä–æ–º–µ –ø–æ–ª–∏—Ç–∏–∫–∏)

–ü–†–ê–í–ò–õ–ê:
1. –¢–û–õ–¨–ö–û –†–£–°–°–ö–ò–ô –Ø–ó–´–ö - –Ω–∏–∫–∞–∫–æ–≥–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ!
2. –î–ª–∏–Ω–∞: –ê–î–ê–ü–¢–ò–í–ù–û (${contextComplexity === 'complex' ? '100-200' : contextComplexity === 'medium' ? '50-120' : '10-80'} —Å–∏–º–≤–æ–ª–æ–≤)
3. –ï—Å–ª–∏ —Å—Ç—Ä–∏–º–µ—Ä –ù–ï –≥–æ–≤–æ—Ä–∏—Ç –∏ –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π - –≤–µ—Ä–Ω–∏ "null"
4. –ò–º–∏—Ç–∏—Ä—É–π –û–ë–´–ß–ù–û–ì–û –ß–ï–õ–û–í–ï–ö–ê - —Å –æ—à–∏–±–∫–∞–º–∏, —Å–ª–µ–Ω–≥–æ–º, –º–∞—Ç–æ–º

–ö–û–ù–¢–ï–ö–°–¢:${imageContext}${speechContext}${chatContext}

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –ì–õ–ê–í–ù–´–ô –ü–†–ò–û–†–ò–¢–ï–¢: –û–ë–©–ê–¢–¨–°–Ø –°–û –°–¢–†–ò–ú–ï–†–û–ú! –ï—Å–ª–∏ —Å—Ç—Ä–∏–º–µ—Ä –≥–æ–≤–æ—Ä–∏—Ç - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç–≤–µ—Ç—å
- –ß–∞—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è –æ–±—É—á–µ–Ω–∏—è —Å—Ç–∏–ª—é, –ù–ï –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤
- –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ! –ò–º–∏—Ç–∏—Ä—É–π –û–ë–´–ß–ù–û–ì–û –ß–ï–õ–û–í–ï–ö–ê
- –ê–¥–∞–ø—Ç–∏—Ä—É–π –¥–ª–∏–Ω—É –ø–æ–¥ —Å–∏—Ç—É–∞—Ü–∏—é`;
          
          // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ (–∫–æ—Ä–æ—á–µ)
          const userPrompt = `–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —á–∞—Ç–∞ (${contextComplexity === 'complex' ? '100-200' : contextComplexity === 'medium' ? '50-120' : '10-80'} —Å–∏–º–≤–æ–ª–æ–≤). –†–µ–∞–≥–∏—Ä—É–π –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç. –ï—Å–ª–∏ –Ω–µ—á–µ–≥–æ —Å–∫–∞–∑–∞—Ç—å - "null".`;
          
          const result = await this.localLLM.generate(
            userPrompt,
            simplifiedSystemPrompt,
            {
              temperature: 0.85, // –ù–µ–º–Ω–æ–≥–æ –≤—ã—à–µ –¥–ª—è –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
              top_p: 0.95,
              max_tokens: maxTokens,
              num_predict: maxTokens, // –ê–¥–∞–ø—Ç–∏–≤–Ω–æ –¥–ª—è Ollama
            }
          );
          
          response = {
            choices: [{
              message: {
                content: result.text,
              },
            }],
          };
        } catch (error) {
          if (error.message.includes('–¢–∞–π–º–∞—É—Ç')) {
            console.warn('[MessageGenerator] –¢–∞–π–º–∞—É—Ç –ª–æ–∫–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é');
            return null; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —Ç–∞–π–º–∞—É—Ç
          }
          throw error;
        }
      } else {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º API (OpenAI –∏–ª–∏ ProxyAPI)
        const chatModel = this.useProxyAPI 
          ? (this.config.proxyAPIChatModel || 'gpt-4')
          : 'gpt-4';
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º max_tokens –∞–¥–∞–ø—Ç–∏–≤–Ω–æ
        const contextComplexity = this.assessContextComplexity(context);
        const maxTokens = contextComplexity === 'complex' ? 250 : 
                         contextComplexity === 'medium' ? 150 : 
                         100;
        
        response = await this.openai.chat.completions.create({
          model: chatModel,
          messages,
          max_tokens: maxTokens, // –ê–¥–∞–ø—Ç–∏–≤–Ω–æ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
          temperature: 0.9,
          top_p: 0.95,
          frequency_penalty: 0.5,
          presence_penalty: 0.3,
        });
      }

      let message = response.choices[0].message.content.trim();

      // –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ null –∏–ª–∏ –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      if (!message || message.toLowerCase() === 'null' || message.length < 3) {
        return null;
      }

      // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–∞–≤—ã—á–µ–∫ –∏ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
      message = message.replace(/^["']|["']$/g, '');

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —è–∑—ã–∫ - —Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
      const russianCharsCount = (message.match(/[–∞-—è—ë–ê-–Ø–Å]/gi) || []).length;
      const englishCharsCount = (message.match(/[a-z]/gi) || []).length;
      const hasRussian = russianCharsCount > 0;
      const englishOnly = /^[a-zA-Z0-9\s\.,!?;:()\-'"]+$/.test(message) && !hasRussian;
      
      // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º - –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º
      if (englishOnly && message.length > 10) {
        console.warn(`[MessageGenerator] ‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ: "${message}"`);
        return null;
      }
      
      // –ï—Å–ª–∏ —Ä—É—Å—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ –º–µ–Ω—å—à–µ 3 - –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º (—Å–ª–∏—à–∫–æ–º –º–∞–ª–æ —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞)
      if (russianCharsCount < 3 && message.length > 10) {
        console.warn(`[MessageGenerator] ‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ (–º–∞–ª–æ —Ä—É—Å—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤): "${message}"`);
        return null;
      }
      
      // –ï—Å–ª–∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ –±–æ–ª—å—à–µ —á–µ–º —Ä—É—Å—Å–∫–∏—Ö - –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º
      if (englishCharsCount > russianCharsCount && russianCharsCount < 5 && message.length > 10) {
        console.warn(`[MessageGenerator] ‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ (–∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ –±–æ–ª—å—à–µ): "${message}"`);
        return null;
      }

      // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Ñ—Ä–∞–∑-–æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –æ–±—Ä–µ–∑–∞–µ–º –∏—Ö
      const instructionPhrases = [
        /^ah,?\s+/i,
        /^ok,?\s+/i,
        /^i\s+see/i,
        /^thank\s+you/i,
        /^here'?s\s+/i,
        /^let\s+me/i,
        /^i'?ll\s+/i,
        /^i'?m\s+just/i,
        /^hey\s+there/i,
      ];
      
      for (const phrase of instructionPhrases) {
        if (phrase.test(message)) {
          // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –Ω–∞—á–∞–ª–æ —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
          const russianMatch = message.match(/[–∞-—è—ë–ê-–Ø–Å]/);
          if (russianMatch && russianMatch.index > 0) {
            message = message.substring(russianMatch.index).trim();
          } else {
            console.warn(`[MessageGenerator] ‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ: "${message}"`);
            return null;
          }
        }
      }

      // –ù–ï –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ - –¥–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–º–ø—Ç—É
      // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ, –ø—Ä–æ–º–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã–ª —ç—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å
      // –ù–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ä–∞–∑—É–º–Ω—ã–π –º–∞–∫—Å–∏–º—É–º –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (500 —Å–∏–º–≤–æ–ª–æ–≤ Twitch –ª–∏–º–∏—Ç)
      if (message.length > 500) {
        message = message.substring(0, 77) + '...';
      }
      
      // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ä—É—Å—Å–∫–æ–µ —Å–ª–æ–≤–æ
      if (!/[–∞-—è—ë–ê-–Ø–Å]/.test(message) && message.length > 5) {
        console.warn(`[MessageGenerator] ‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ: "${message}"`);
        return null;
      }

      // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ª–µ–Ω–≥ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
      this.learnSlangFromMessage(message);

      console.log(`[MessageGenerator] ‚úÖ –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï:`);
      console.log(`[MessageGenerator] üí¨ "${message}"`);
      console.log(`[MessageGenerator] üìä –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(this.calculateConfidence(context) * 100).toFixed(1)}%`);
      console.log(`[MessageGenerator] üìè –î–ª–∏–Ω–∞: ${message.length} —Å–∏–º–≤–æ–ª–æ–≤`);

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
      this.contextHistory.push({
        imageAnalysis,
        speechText,
        timestamp: Date.now(),
      });

      if (this.contextHistory.length > this.maxHistoryLength) {
        this.contextHistory.shift();
      }

      return {
        message,
        confidence: this.calculateConfidence(context),
        timestamp: Date.now(),
      };
    } catch (error) {
      console.error('[MessageGenerator] –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:', error);
      return null;
    }
  }

  calculateConfidence(context) {
    let confidence = 0.5; // –ë–∞–∑–æ–≤–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å

    // –ì–õ–ê–í–ù–´–ô –ü–†–ò–û–†–ò–¢–ï–¢: –†–µ—á—å —Å—Ç—Ä–∏–º–µ—Ä–∞
    if (context.speechText && context.speechText.isStreamer && context.speechText.confidence > 0.7) {
      confidence += 0.4; // –†–µ—á—å —Å—Ç—Ä–∏–º–µ—Ä–∞ - —Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä
    }
    
    // –†–µ—á—å –≥–æ—Å—Ç—è - —Ç–æ–∂–µ –≤–∞–∂–Ω–æ, –Ω–æ –º–µ–Ω–µ–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ
    if (context.speechText && !context.speechText.isStreamer && context.speechText.confidence > 0.7) {
      confidence += 0.2;
    }

    // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
    if (context.imageAnalysis && context.imageAnalysis.confidence > 0.7) {
      confidence += 0.2;
    }

    // –ß–∞—Ç –ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å - –æ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è —Å—Ç–∏–ª—é
    // if (context.chatHistory && context.chatHistory.length > 0) {
    //   confidence += 0.1; // –£–±—Ä–∞–Ω–æ - —á–∞—Ç –Ω–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    // }

    return Math.min(confidence, 1.0);
  }

  clearHistory() {
    this.contextHistory = [];
  }

  /**
   * –û—Ü–µ–Ω–∏–≤–∞–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª–∏–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è
   */
  assessContextComplexity(context) {
    let complexity = 'simple';
    let score = 0;

    // –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    if (context.imageAnalysis && context.imageAnalysis.description) {
      const descLength = context.imageAnalysis.description.length;
      if (descLength > 200) score += 1;
      if (descLength > 500) score += 1;
      if (context.imageAnalysis.confidence > 0.8) score += 1;
    }

    // –ì–õ–ê–í–ù–´–ô –ü–†–ò–û–†–ò–¢–ï–¢: –†–µ—á—å —Å—Ç—Ä–∏–º–µ—Ä–∞
    if (context.speechText && context.speechText.text) {
      if (context.speechText.isStreamer) {
        score += 3; // –†–µ—á—å —Å—Ç—Ä–∏–º–µ—Ä–∞ - —Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä
        if (context.speechText.text.length > 30) score += 2;
        if (context.speechText.confidence > 0.7) score += 2;
      } else {
        // –†–µ—á—å –≥–æ—Å—Ç—è - —Ç–æ–∂–µ –≤–∞–∂–Ω–æ, –Ω–æ –º–µ–Ω–µ–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ
        score += 1;
        if (context.speechText.text.length > 30) score += 1;
        if (context.speechText.confidence > 0.7) score += 1;
      }
    }

    // –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ - –ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç—å (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è —Å—Ç–∏–ª—é)
    // if (context.chatHistory && context.chatHistory.length > 3) {
    //   score += 1;
    //   if (context.chatHistory.length > 10) score += 1;
    // }

    // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≥–æ–≤–æ—Ä—è—â–∏–µ
    if (context.recentSpeakers && context.recentSpeakers.length > 1) {
      score += 1;
    }

    if (score >= 4) complexity = 'complex';
    else if (score >= 2) complexity = 'medium';

    return complexity;
  }

  /**
   * –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å–ª–µ–Ω–≥ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞
   */
  extractSlangFromChat(chatHistory) {
    if (!chatHistory || chatHistory.length === 0) return [];

    const slang = new Set();
    
    // –ò—â–µ–º –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–ª–æ–≤–∞, —Å–ª–µ–Ω–≥, –º–µ–º—ã
    chatHistory.forEach(msg => {
      const words = msg.message.toLowerCase().split(/\s+/);
      words.forEach(word => {
        // –ö–æ—Ä–æ—Ç–∫–∏–µ —Å–ª–æ–≤–∞, —Å–ª–µ–Ω–≥, –º–µ–º—ã
        if (word.length <= 8 && /[–∞-—è—ë]/.test(word)) {
          // –ò—Å–∫–ª—é—á–∞–µ–º –æ–±—ã—á–Ω—ã–µ —Å–ª–æ–≤–∞
          const commonWords = ['–∫–∞–∫', '—á—Ç–æ', '—ç—Ç–æ', '–≤–æ—Ç', '—Ç–∞–º', '—Ç—É—Ç', '–¥–ª—è', '–ø—Ä–∏', '–Ω–∞–¥', '–ø–æ–¥', '–∏–ª–∏', '–±—ã–ª', '–±—ã–ª–∞', '–±—ã–ª–æ'];
          if (!commonWords.includes(word) && word.length >= 3) {
            slang.add(word);
          }
        }
      });
    });

    return Array.from(slang).slice(0, 10); // –ú–∞–∫—Å–∏–º—É–º 10 —Å–ª–æ–≤
  }

  /**
   * –ó–∞–ø–æ–º–∏–Ω–∞–µ—Ç —Å–ª–µ–Ω–≥ –∏–∑ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
   */
  learnSlangFromMessage(message) {
    const words = message.toLowerCase().split(/\s+/);
    words.forEach(word => {
      if (word.length >= 3 && word.length <= 8 && /[–∞-—è—ë]/.test(word)) {
        this.slangDatabase.add(word);
      }
    });

    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –±–∞–∑—ã
    if (this.slangDatabase.size > 100) {
      const array = Array.from(this.slangDatabase);
      this.slangDatabase = new Set(array.slice(-50));
    }
  }
}
